<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }

        #content {
            max-width: 800px;
            margin: auto;
        }

        table {
            width: 100%;
            border: 1px solid #ddd;
            border-collapse: collapse;
            margin: 1em 0;
        }

        th {
            text-align: left;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <div id="back-btn-container"></div>
    <div id="content">加载中...</div>
    <script>
        // 定义一些常量
        const defaultFile = 'index';
        const defaultTitle = 'Index';
        const testHTMLonFail = true; // 是否在加载失败时尝试加载同名 HTML 文件
        const testNotFoundFailbackToIndex = true; // 是否检查服务端因加载失败时回退到 index 页面而不是显示 404 错误


        function cleanUrl(href) {
            try {
                href = encodeURI(href).replace(/%25/g, '%');
            } catch {
                return null;
            }
            return href;
        }

        marked.use({
            renderer: {
                link({ href, title, tokens }) {
                    const text = this.parser.parseInline(tokens);
                    const cleanHref = cleanUrl(href);
                    if (cleanHref === null) {
                        return text;
                    }
                    href = cleanHref;
                    const out = `<a href="${href}" target="_blank"${title ? ` title="${escape(title)}"` : ''}>${text}</a>`;
                    return out;
                }
            }
        })

        function getHash() {
            let hash = location.hash.replace(/^#/, '')
            if (!hash) {
                let path = location.pathname;
                // 只取目录部分
                path = path.slice(0, path.lastIndexOf('/') + 1);
                hash = path + defaultFile; // 默认加载 defaultFile
            }
            // 如果 hash 以 / 开头，去掉它
            if (hash.startsWith('/')) {
                hash = hash.slice(1);
            }
            // 如果 hash 以 .md 结尾，去掉它
            if (hash.endsWith('.md')) {
                hash = hash.slice(0, -3);
            }
            // 如果 hash 指向的文件名为空，默认加载 defaultFile
            if (!hash || hash.endsWith('/')) {
                hash += defaultFile;
            }
            return hash;
        }

        function isIndexPage() {
            let hash = getHash();
            if (hash === defaultFile) {
                return true;
            }
            return false;
        }

        function renderBackButton() {
            const container = document.querySelector('#back-btn-container');
            container.innerHTML = '';
            if (!isIndexPage()) {
                const a = document.createElement('a');
                a.href = './';
                a.style = 'display:inline-block;margin-bottom:1em;';
                a.textContent = '← 返回';
                container.appendChild(a);
            }
        }

        function loadMarkdownFromHash() {
            renderBackButton();
            const file = getHash();
            fetch(`/${file}.md`)
                .then(response => {
                    if (!response.ok) throw new Error();
                    return response.text();
                })
                .then(md => {
                    if (testNotFoundFailbackToIndex) {
                        const htmlIndicators = ['<!doctype html>', '<html', '<head', '<body'];
                        const lowerMd = md.trim().toLowerCase();
                        if (htmlIndicators.some(ind => lowerMd.includes(ind))) {
                            // 如果加载的内容是 HTML，说明服务端返回了 index 页面而不是 404 错误
                            throw new Error('Page is HTML, Markdown is Not Found');
                        }
                    }
                    // 提取 Markdown 第一行标题
                    let title = defaultTitle;
                    const match = md.match(/^#\s+(.+)$/m);
                    if (match) {
                        title = match[1].trim();
                    }
                    document.title = title;
                    document.querySelector('#content').innerHTML = marked.parse(md);
                })
                .catch((e) => {
                    if (!testHTMLonFail) {
                        document.title = defaultTitle;
                        document.querySelector('#content').textContent = `无法加载 ${file}.md 文件。`;
                        console.error(`无法加载 ${file}.md 文件。`, e);
                        return;
                    }
                    // 尝试加载同名 html 文件
                    fetch(`/${file}.html`, { method: 'HEAD' })
                        .then(res => {
                            if (res.ok) {
                                // 跳转到 html 页面
                                location.href = `/${file}.html`;
                            } else {
                                document.title = defaultTitle;
                                document.querySelector('#content').textContent = `无法加载 ${file}.md 文件。`;
                                console.error(`无法加载 ${file}.md 文件。`, e);
                            }
                        })
                        .catch(() => {
                            document.title = defaultTitle;
                            document.querySelector('#content').textContent = `无法加载 ${file}.md 文件。`;
                            console.error(`无法加载 ${file}.md 文件。`, e);
                        });
                });
        }

        // 初始加载
        loadMarkdownFromHash();

        // 监听 hash 变化
        window.addEventListener('hashchange', loadMarkdownFromHash);

        // 拦截页面内跳转
        document.addEventListener('click', function (e) {
            const a = e.target.closest('a');
            if (a && a.href && a.origin === location.origin) {
                e.preventDefault();
                // 去除 .md 后缀以确保hash美观
                location.hash = a.pathname.replace(/\.md$/, '');
            }
        });
    </script>
</body>

</html>