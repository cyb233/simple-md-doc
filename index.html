<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>Index</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 2em;
        }

        #content {
            max-width: 800px;
            margin: auto;
        }

        table {
            width: 100%;
            border: 1px solid #ddd;
            border-collapse: collapse;
            margin: 1em 0;
        }

        th {
            text-align: left;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <div id="back-btn-container"></div>
    <div id="content">加载中...</div>
    <script>
        function cleanUrl(href) {
            try {
                href = encodeURI(href).replace(/%25/g, '%');
            } catch {
                return null;
            }
            return href;
        }

        marked.use({
            renderer: {
                link({ href, title, tokens }) {
                    const text = this.parser.parseInline(tokens);
                    const cleanHref = cleanUrl(href);
                    if (cleanHref === null) {
                        return text;
                    }
                    href = cleanHref;
                    const out = `<a href="${href}" target="_blank"${title ? ` title="${escape(title)}"` : ''}>${text}</a>`;
                    return out;
                }
            }
        })

        function getHash() {
            let hash = location.hash.replace(/^#/, '')
            if (!hash) {
                let path = location.pathname;
                // 只取目录部分
                path = path.slice(0, path.lastIndexOf('/') + 1);
                hash = path + 'index'; // 默认加载 index
            }
            // 如果 hash 以 / 开头，去掉它
            if (hash.startsWith('/')) {
                hash = hash.slice(1);
            }
            // 如果 hash 以 .md 结尾，去掉它
            if (hash.endsWith('.md')) {
                hash = hash.slice(0, -3);
            }
            // 如果 hash 指向的文件名为空，默认加载 index
            if (!hash || hash.endsWith('/')) {
                hash += 'index';
            }
            return hash;
        }

        function isIndexPage() {
            let hash = getHash();
            if (hash === 'index') {
                return true;
            }
            return false;
        }

        function renderBackButton() {
            const container = document.querySelector('#back-btn-container');
            container.innerHTML = '';
            if (!isIndexPage()) {
                const a = document.createElement('a');
                a.href = './';
                a.style = 'display:inline-block;margin-bottom:1em;';
                a.textContent = '← 返回';
                container.appendChild(a);
            }
        }

        function loadMarkdownFromHash() {
            renderBackButton();
            const file = getHash();
            fetch(`/${file}.md`)
                .then(response => {
                    if (!response.ok) throw new Error();
                    return response.text();
                })
                .then(md => {
                    // 提取 Markdown 第一行标题
                    let title = 'Index';
                    const match = md.match(/^#\s+(.+)$/m);
                    if (match) {
                        title = match[1].trim();
                    }
                    document.title = title;
                    document.querySelector('#content').innerHTML = marked.parse(md);
                })
                .catch((e) => {
                    // 新增：尝试加载同名 html 文件
                    fetch(`/${file}.html`, { method: 'HEAD' })
                        .then(res => {
                            if (res.ok) {
                                // 跳转到 html 页面
                                location.href = `/${file}.html`;
                            } else {
                                document.title = 'Index';
                                document.querySelector('#content').textContent = `无法加载 ${file}.md 文件。`;
                                console.error(`无法加载 ${file}.md 文件。`, e);
                            }
                        })
                        .catch(() => {
                            document.title = 'Index';
                            document.querySelector('#content').textContent = `无法加载 ${file}.md 文件。`;
                            console.error(`无法加载 ${file}.md 文件。`, e);
                        });
                });
        }

        // 初始加载
        loadMarkdownFromHash();

        // 监听 hash 变化
        window.addEventListener('hashchange', loadMarkdownFromHash);

        // 拦截页面内跳转
        document.addEventListener('click', function (e) {
            const a = e.target.closest('a');
            if (a && a.href && a.origin === location.origin) {
                e.preventDefault();
                // 去除 .md 后缀以确保hash美观
                location.hash = a.pathname.replace(/\.md$/, '');
            }
        });
    </script>
</body>

</html>